{# =========================
   product-page.njk — Hyper style (gallery glow + sticky summary + chic variants)
   ========================= #}

<div class="product-wrapper component hyper-product" data-component-id="{{ componentId }}">
  <div class="container">

    <section class="py-5-nav">
      <div class="container px-4 px-lg-5 my-5">
        <div class="row gx-4 gx-lg-5 align-items-start hyper-row">

          {# ----------- GALLERY ----------- #}
          <div class="col-lg-6">
            <div class="prod-gallery reveal" id="prodGallery">
              {% if product.image_urls|length > 0 %}
              <div class="carousel slide" id="productImageCarousel" data-bs-ride="carousel">
                <div class="carousel-inner">
                  {% for image in product.image_urls %}
                  <div class="carousel-item {{ 'active' if loop.first }}">
                    <div class="frame">
                      <img src="{{ image }}" alt="{{ product.name }}" />
                      <span class="halo" aria-hidden="true"></span>
                    </div>
                  </div>
                  {% endfor %}
                </div>

                {% if product.image_urls|length > 1 %}
                <div class="thumbnails">
                  {% for image in product.image_urls %}
                  <button
                    type="button"
                    data-bs-target="#productImageCarousel"
                    data-bs-slide-to="{{ loop.index0 }}"
                    class="{{ 'active' if loop.first }}"
                    aria-label="Preview {{ loop.index }}"
                  >
                    <img src="{{ image }}" alt="thumb {{ loop.index }}" />
                  </button>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              {% elif product.image_url %}
              <div class="frame">
                <img src="{{ product.image_url }}" alt="{{ product.name }}" />
                <span class="halo" aria-hidden="true"></span>
              </div>
              {% else %}
              <div class="frame placeholder">
                <div
                  class="product-img-placeholder"
                  style="color: {{ global.properties.theme_color }};"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 256 256" class="large">
                    <path fill="currentColor" d="m222.72 67.91l-88-48.18a13.9 13.9 0 0 0-13.44 0l-88 48.18A14 14 0 0 0 26 80.18v95.64a14 14 0 0 0 7.28 12.27l88 48.18a13.92 13.92 0 0 0 13.44 0l88-48.18a14 14 0 0 0 7.28-12.27V80.18a14 14 0 0 0-7.28-12.27Z"/>
                  </svg>
                </div>
              </div>
              {% endif %}

              {# Tabs sous l’image #}
              <div x-data="{ activeTab: 'description' }" class="prod-tabs">
                {% if product.product_tabs|length > 0 %}
                <div class="tab-pills">
                  <button type="button" @click="activeTab = 'description'" :class="{'active': activeTab == 'description'}">Description</button>
                  {% for productTab in product.product_tabs %}
                    <button type="button" @click="activeTab = '{{ productTab.slug }}'" :class="{'active': activeTab == '{{ productTab.slug }}'}">{{ productTab.title }}</button>
                  {% endfor %}
                </div>
                {% endif %}

                <div class="tab-content">
                  <template x-if="activeTab == 'description'">
                    <div class="editor">{{ product.description | safe }}</div>
                  </template>
                  {% for productTab in product.product_tabs %}
                    <template x-if="activeTab == '{{ productTab.slug }}'">
                      <div class="editor">{{ productTab.content | safe }}</div>
                    </template>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          {# ----------- SUMMARY / VARIANTS ----------- #}
          <div class="col-lg-6">
            <div class="prod-summary reveal" x-data="productForm">
              <div class="title-stack">
                <h1 class="prod-title">{{ product.name }}</h1>
                {% if product.status_color or product.status_text %}
                <div class="status-chip" style="--chip: {{ product.status_color }}">
                  <span class="dot"></span>
                  <span class="txt">{{ product.status_text }}</span>
                </div>
                {% endif %}
              </div>

              {# live stats (garde ta logique) #}
              {% if 'sales' in liveStats or 'views' in liveStats %}
              <div class="live-stats">
                {% if 'views' in liveStats %}
                <div class="stat"><i class="fa-regular fa-eye"></i>
                  <span><b>{{ liveStats.views }}</b> {{ 'person is' if liveStats.views == 1 else 'people are' }} viewing</span>
                </div>
                {% endif %}
                {% if 'sales' in liveStats %}
                {% set salesCountHoursLabelMap = {'1':'hour','6':'6 hours','12':'12 hours','24':'24 hours','168':'7 days','720':'30 days'} %}
                <div class="stat"><i class="fa-solid fa-bag-shopping"></i>
                  <span><b>{{ liveStats.sales }}</b> {{ 'person has' if liveStats.sales == 1 else 'people have' }} purchased{{ '.' if not product.sales_count_hours in salesCountHoursLabelMap else (' in the last ' ~ salesCountHoursLabelMap[product.sales_count_hours] ~ '.') }}</span>
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if product.product_badges.page|length > 0 %}
              <div class="page-badges">
                {% for productBadge in product.product_badges.page %}
                <span class="pill" style="--pill: {{ productBadge.color }}">
                  {% if productBadge.icon %}<i class="{{ productBadge.icon }}"></i>{% endif %}
                  {{ productBadge.label }}
                </span>
                {% endfor %}
              </div>
              {% endif %}

              <div class="price-stock">
                <div class="price-chip">
                  <i class="fa-solid fa-tag"></i>
                  <span class="value" x-text="appCurrency.format(totalPrice, '{{ product.currency }}')"></span>
                </div>

                <div class="stock-area">
                  {% if product.visibility == 'on_hold' %}
                    <span class="stock-chip hold">Product On Hold</span>
                  {% else %}
                    <div x-show="activeVariant in product.variants">
                      <span x-show="product.variants[activeVariant].stock > 0 || product.variants[activeVariant].stock === -1" class="stock-chip ok">
                        <template x-if="product.variants[activeVariant].stock === -1">
                          <span class="stock-unl"><i class="fa-solid fa-infinity"></i> In Stock</span>
                        </template>
                        <template x-if="product.variants[activeVariant].stock > 0 && !product.hide_stock_count">
                          <span x-text="product.variants[activeVariant].stock + ' In Stock'"></span>
                        </template>
                        <template x-if="product.variants[activeVariant].stock > 0 && product.hide_stock_count">
                          <span>In Stock</span>
                        </template>
                      </span>
                      <span x-show="product.variants[activeVariant].stock === 0" x-cloak class="stock-chip out">
                        <i class="fa-solid fa-triangle-exclamation"></i> Out of Stock
                      </span>
                    </div>
                  {% endif %}
                </div>
              </div>

              {# === Product Form (garde ta logique existante) === #}
              <div class="form-shell">
                {% render_snippet "product-form.njk", product=product %}
              </div>

              {# Aide: styles pour variants "génériques"
                 (s’appliquent si ton product-form génère des listes radio/labels standard) #}
              <div class="variants-help-note" aria-hidden="true"></div>
            </div>
          </div>
        </div>

        {# ----------- UPSELLS ----------- #}
        {% if productUpsells.length > 0 %}
        <div class="row gx-4 gx-lg-5 mt-5">
          <div class="col">
            <div class="section-title">
              <h2>Commonly Bought Together</h2>
            </div>
            <div class="row products">
              {% set ogProduct = product %}
              {% for upsell in productUpsells %}
                {% render_snippet "product-card.njk", product=upsell %}
              {% endfor %}
              {% set product = ogProduct %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </section>
  </div>
</div>

{# ---------------------- NOTIFS DE VENTE (inchangé) ---------------------- #}
{% if 'latestOrders' in liveStats and liveStats.latestOrders|length > 0 %}
<link href="https://cdn.jsdelivr.net/npm/flag-icons@7.3.2/css/flag-icons.min.css" rel="stylesheet" integrity="sha256-tyPeBlnZW2qWbAF1hQiCt9qo6SOgOSymvJBum+FrrwI=" crossorigin="anonymous">
<div x-data="salesNotifications" x-cloak class="notification-container">
  <div x-show="show" class="notification-popup">
    <template x-if="order">
      <div class="notification-content">
        {% if product.image_urls|length > 0 %}
          <div class="notification-image-container"><img src="{{ product.image_urls[0] }}" alt="{{ product.name }} image" class="notification-image"></div>
        {% endif %}
        <div class="notification-text truncate">
          <p class="notification-text-primary text-muted">Someone
            <template x-if="order.country_code">
              <span>from <i :class="`flag-icon fi fi-${order.country_code.toLowerCase()}`"></i></span>
            </template>
            purchased
          </p>
          <p class="notification-text-secondary">{{ product.name }}</p>
          <p class="notification-text-tertiary text-muted"><span x-text="getTimeAgo(order.completed_at)"></span></p>
        </div>
      </div>
    </template>
  </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('salesNotifications', () => ({
    displayTime: 8000, initTimeMin: 2000, initTimeMax: 4000, nextTimeMin: 8000, nextTimeMax: 12000,
    latestOrders: {{ liveStats.latestOrders | json }}, show: false,
    get order(){ return this.latestOrders.length > 0 ? this.latestOrders[0] : null; },
    getRandomInterval(min,max){ return Math.floor(Math.random()*(max-min+1))+min; },
    getTimeAgo(input){
      const date = (input instanceof Date) ? input : new Date(input);
      const f = new Intl.RelativeTimeFormat('en'); const ranges = {years:31536000,weeks:604800,days:86400,hours:3600,minutes:60,seconds:1};
      const sec = (date.getTime() - Date.now())/1000; for (let k in ranges) if (ranges[k] < Math.abs(sec)) return f.format(Math.round(sec/ranges[k]), k);
      return 'just now';
    },
    showNotification(){
      if(!this.latestOrders.length) return;
      this.show = true;
      setTimeout(()=>{ this.show=false; setTimeout(()=>{ this.latestOrders.shift(); if(this.latestOrders.length){ setTimeout(()=>this.showNotification(), this.getRandomInterval(this.nextTimeMin,this.nextTimeMax)); }}, 500); }, this.displayTime);
    },
    init(){ setTimeout(()=>this.showNotification(), this.getRandomInterval(this.initTimeMin,this.initTimeMax)); }
  }));
});
</script>
{% endif %}

{# ---------------------- CAROUSEL THUMBS ACTIVE ---------------------- #}
{% if product.image_urls|length > 1 %}
<script>
document.querySelectorAll('.thumbnails button').forEach((b)=>b.addEventListener('click',()=>{
  b.parentNode.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
}));
</script>
{% endif %}

<style>
.hyper-product[data-component-id="{{ componentId }}"]{
  --accent: var(--mono-accent, #ff5aa0);
  --accent-2:#ff88bd;
  --ink:#f4f5fb; --muted:#c7bfcb;
  --stroke: rgba(255,255,255,.08);
}

.hyper-product[data-component-id="{{ componentId }}"] .hyper-row{ row-gap: 28px; }
.hyper-product[data-component-id="{{ componentId }}"] .prod-summary{
  position: sticky; top: clamp(70px, 8vh, 110px);
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
  border:1px solid var(--stroke); border-radius:16px; padding:18px; box-shadow:0 18px 48px rgba(0,0,0,.45);
}

.hyper-product[data-component-id="{{ componentId }}"] .title-stack{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.hyper-product[data-component-id="{{ componentId }}"] .prod-title{ margin:0; color:#fff; font-weight:900; letter-spacing:-.015em; line-height:1.05; font-size: clamp(28px,3.6vw,46px); }
.hyper-product[data-component-id="{{ componentId }}"] .status-chip{
  display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14);
  background: color-mix(in oklab, var(--chip) 24%, black); color: color-mix(in oklab, var(--chip) 85%, white);
}
.hyper-product[data-component-id="{{ componentId }}"] .status-chip .dot{ width:8px; height:8px; border-radius:50%; background: var(--chip); box-shadow: 0 0 12px color-mix(in oklab, var(--chip) 50%, transparent); }


.hyper-product[data-component-id="{{ componentId }}"] .live-stats{ display:grid; gap:6px; margin:10px 0 4px; }
.hyper-product[data-component-id="{{ componentId }}"] .live-stats .stat{ display:flex; align-items:center; gap:8px; color:var(--muted); }
.hyper-product[data-component-id="{{ componentId }}"] .live-stats .stat i{ color:var(--accent-2) }


.hyper-product[data-component-id="{{ componentId }}"] .page-badges{ display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 14px; }
.hyper-product[data-component-id="{{ componentId }}"] .page-badges .pill{
  --p: var(--pill, var(--accent));
  display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:800; color:#140f13;
  background:linear-gradient(90deg, color-mix(in oklab, var(--p) 86%, black), var(--p));
  box-shadow:0 10px 22px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.35);
}


.hyper-product[data-component-id="{{ componentId }}"] .price-stock{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0 12px; }
.hyper-product[data-component-id="{{ componentId }}"] .price-chip{
  display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:12px;
  color:#140f13; font-weight:900; letter-spacing:.01em;
  background:linear-gradient(90deg,var(--accent-2),var(--accent));
  box-shadow:0 14px 30px rgba(255,90,160,.35), inset 0 1px 0 rgba(255,255,255,.4);
}
.hyper-product[data-component-id="{{ componentId }}"] .price-chip .value{ font-size:1.15rem; }
.hyper-product[data-component-id="{{ componentId }}"] .stock-area{ display:flex; align-items:center; gap:8px; }
.hyper-product[data-component-id="{{ componentId }}"] .stock-chip{
  display:inline-flex; align-items:center; gap:8px; padding:7px 12px; border-radius:999px; font-weight:800; border:1px solid rgba(255,255,255,.12);
}
.hyper-product[data-component-id="{{ componentId }}"] .stock-chip.ok{ color:#052015; background:linear-gradient(90deg,#10d28a,#00b877) }
.hyper-product[data-component-id="{{ componentId }}"] .stock-chip.out{ color:#2a0a12; background:linear-gradient(90deg,#ff5a6c,#e04153) }
.hyper-product[data-component-id="{{ componentId }}"] .stock-chip.hold{ color:#2a1632; background:linear-gradient(90deg,#9c6cff,#6a4df6) }
.hyper-product[data-component-id="{{ componentId }}"] .stock-unl{ display:inline-flex; gap:6px; align-items:center }

.hyper-product[data-component-id="{{ componentId }}"] .form-shell{
  margin-top:12px; padding:10px; border-radius:14px;
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
  border:1px solid var(--stroke);
}

.hyper-product[data-component-id="{{ componentId }}"] .form-shell .variants,
.hyper-product[data-component-id="{{ componentId }}"] .form-shell .options{ display:grid; gap:10px; }
.hyper-product[data-component-id="{{ componentId }}"] .form-shell label,
.hyper-product[data-component-id="{{ componentId }}"] .form-shell .variant,
.hyper-product[data-component-id="{{ componentId }}"] .form-shell .option,
.hyper-product[data-component-id="{{ componentId }}"] .form-shell [data-variant-id]{
  display:grid; grid-template-columns: 1fr auto; align-items:center; gap:12px;
  padding:12px 14px; border-radius:12px; cursor:pointer;
  border:1px solid rgba(255,255,255,.08);
  background: radial-gradient(650px 220px at 20% 0%, rgba(255,90,160,.06), transparent 60%),
              linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.hyper-product[data-component-id="{{ componentId }}"] .form-shell label:hover,
.hyper-product[data-component-id="{{ componentId }}"] .form-shell .variant:hover,
.hyper-product[data-component-id="{{ componentId }}"] .form-shell .option:hover,
.hyper-product[data-component-id="{{ componentId }}"] .form-shell [data-variant-id]:hover{
  border-color: rgba(255,90,160,.35); transform: translateY(-1px);
  box-shadow: 0 14px 32px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
}
.hyper-product[data-component-id="{{ componentId }}"] .form-shell .price-right{ color:#f4f5fb; font-weight:900; opacity:.95; }
.hyper-product[data-component-id="{{ componentId }}"] .form-shell input[type="radio"]{ accent-color: var(--accent); }


.hyper-product[data-component-id="{{ componentId }}"] .prod-gallery .frame{
  position:relative; overflow:hidden; border-radius:16px;
  border:1px solid var(--stroke); background:#0e0b10;
  aspect-ratio: 16/9;
  box-shadow:0 18px 48px rgba(0,0,0,.45);
  transform: translateZ(0);
}
.hyper-product[data-component-id="{{ componentId }}"] .prod-gallery img{
  width:100%; height:100%; object-fit:cover; display:block;
  transform: scale(1.02); transition: transform .6s cubic-bezier(.22,1,.36,1), filter .35s;
  filter: brightness(.98) contrast(1.02);
}
.hyper-product[data-component-id="{{ componentId }}"] .prod-gallery .frame:hover img{ transform: scale(1.06); }
.hyper-product[data-component-id="{{ componentId }}"] .prod-gallery .halo{
  content:""; position:absolute; right:-18%; bottom:-20%; width:680px; height:680px; border-radius:50%;
  background: radial-gradient(circle at 50% 50%, color-mix(in oklab, var(--accent) 28%, transparent) 0, transparent 60%);
  filter: blur(50px); opacity:.6; pointer-events:none;
}


.hyper-product[data-component-id="{{ componentId }}"] .thumbnails{
  display:flex; gap:10px; overflow:auto; padding:10px 2px 2px; margin-top:10px;
}
.hyper-product[data-component-id="{{ componentId }}"] .thumbnails button{
  border:1px solid var(--stroke); background:#0f0b11; border-radius:10px; padding:0; flex:0 0 96px; aspect-ratio:16/9; overflow:hidden;
  opacity:.85; transition:opacity .2s,border-color .2s, transform .2s;
}
.hyper-product[data-component-id="{{ componentId }}"] .thumbnails button.active,
.hyper-product[data-component-id="{{ componentId }}"] .thumbnails button:hover{
  opacity:1; border-color: rgba(255,90,160,.35); transform: translateY(-1px);
}
.hyper-product[data-component-id="{{ componentId }}"] .thumbnails img{ width:100%; height:100%; object-fit:cover; display:block; }


.hyper-product[data-component-id="{{ componentId }}"] .prod-tabs{ margin-top:16px; }
.hyper-product[data-component-id="{{ componentId }}"] .tab-pills{ display:flex; flex-wrap:wrap; gap:10px; }
.hyper-product[data-component-id="{{ componentId }}"] .tab-pills button{
  padding:8px 12px; border-radius:999px; border:1px solid var(--stroke); color:#f4f5fb; background:rgba(255,255,255,.02); font-weight:800;
}
.hyper-product[data-component-id="{{ componentId }}"] .tab-pills button.active{
  color:#140f13; background:linear-gradient(90deg,var(--accent-2),var(--accent));
  box-shadow:0 12px 26px rgba(255,90,160,.35), inset 0 1px 0 rgba(255,255,255,.35);
  border-color:transparent;
}
.hyper-product[data-component-id="{{ componentId }}"] .tab-content{
  margin-top:10px; border:1px solid var(--stroke); border-radius:12px; padding:12px;
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); color:#d9d2df;
}

.hyper-product[data-component-id="{{ componentId }}"] .reveal{ opacity:0; transform: translateY(14px); transition: opacity .6s ease, transform .6s ease; }
.hyper-product[data-component-id="{{ componentId }}"] .reveal.in{ opacity:1; transform:none; }

@media (max-width: 992px){
  .hyper-product[data-component-id="{{ componentId }}"] .prod-summary{ position:static; }
}
</style>

<script>
(function(){
  const root = document.querySelector('.hyper-product[data-component-id="{{ componentId }}"]');
  if(!root) return;

  const rev = root.querySelectorAll('.reveal');
  if('IntersectionObserver' in window){
    const io = new IntersectionObserver((e)=>e.forEach(x=>{ if(x.isIntersecting){ x.target.classList.add('in'); io.unobserve(x.target); }}),{threshold:.15, rootMargin:'-10px 0px -10px 0px'});
    rev.forEach(x=>io.observe(x));
  } else { rev.forEach(x=>x.classList.add('in')); }

  const frame = root.querySelector('.prod-gallery .frame');
  if(frame){
    const img = frame.querySelector('img');
    const onMove = (ev)=>{
      const r = frame.getBoundingClientRect();
      const x = (('clientX' in ev ? ev.clientX : ev.touches[0].clientX) - r.left)/r.width - .5;
      const y = (('clientY' in ev ? ev.clientY : ev.touches[0].clientY) - r.top )/r.height - .5;
      img.style.transform = `scale(1.07) translate(${x*8}px, ${y*8}px)`;
    };
    const onLeave = ()=>{ img.style.transform = 'scale(1.02)'; };
    frame.addEventListener('mousemove', onMove, {passive:true});
    frame.addEventListener('mouseleave', onLeave, {passive:true});
    frame.addEventListener('touchstart', onMove, {passive:true});
    frame.addEventListener('touchmove', onMove, {passive:true});
    frame.addEventListener('touchend', onLeave, {passive:true});
  }
})();
</script>